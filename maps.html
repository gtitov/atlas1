<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="map viewer for the web-atlas of Crimea">
    <meta name="keywords" content="atlas, MSU, geography, cartography, Crimea">
    <meta name="author" content="Gman">
    <!-- CSS loading -->
    <link rel="stylesheet" type="text/css" href="./css/style.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./icons/asymbol.png">
    <title>ВИЭ Крыма | Карты</title>
  </head>
  <body>
    <div class="container">
    

        <header class="row">
    
            <div id="brand">
                <h1>возобновляемые источники энергии<br>полуострова Крым</h1>
            </div>
    
            <nav>
                <ul>
                    <li class="hvr-fade"><a href="./index.html">ГЛАВНАЯ</a></li>
                    <li class="current hvr-fade"><a href="./maps.html">КАРТЫ</a></li>
                    <li class="hvr-fade"><a href="./contacts.html">КОНТАКТЫ</a></li>
                </ul>
            </nav>
    
        </header>
    
    
        <div class="row" id="showcase">
                <div id="toggle" onclick="toggleContentTable()">
                        <a href="#">
                            <svg width="30" height="30">
                                <path d="M0,5 30,5" stroke="dodgerblue" stroke-width="5" />
                                <path d="M0,14 30,14" stroke="dodgerblue" stroke-width="5" />
                                <path d="M0,23 30,23" stroke="dodgerblue" stroke-width="5" />
                            </svg>
                        </a>
                </div>
        
            <section id="sidebar">
                <div id="content_table">
                    <h2>Содержание</h2>
                    <div id="table_container"></div>
                </div>
            </section>
    
            <section id="map">
                <img src="">
            </section>
    
            <section id="info">
                <h2 id="obj_title"></h2>
                <p id="obj_description"></p>
            </section>
    
        </div>
    
    
        <footer class="row">
            <p>&copy; 2018 Кафедра картографии и геоинформатики географического факультета МГУ</p>
        </footer>

    </div>








    <!-- JS loading -->
    <script src="./js/CollapsibleLists.js"></script>



    <script>
        /* Объявляем переменные хранения данных */
        var maps
        var sections
        var subsections
        var series

        /* Получаем данные */
        loadData("./php/getMaps.php", getMaps);
        loadData("./php/getSections.php", getSections);
        loadData("./php/getSubsections.php", getSubsections);
        loadData("./php/getSeries.php", getSeries);
        



        /* Создаём таблицу содержания */
        /* Создаём разделы */
        var sect_ul = "<ul id = 'sect_list'>";  // Открываем ul для списка карт
        for(var s in sections) {
            sect_ul += 
                "<li class='sect' id='sect" +sections[s].id+ "'>"  // Создаём li с названием каждого раздела; id равен индексу раздела в массиве 'sections' с префиксом 'sect'
                +sections[s].title+
                "<ul></ul></li>";
        }
        sect_ul += "</ul>";  // Закрываем ul для списка разделов
        document.getElementById('table_container').innerHTML += sect_ul; // Помещаем ul в раздел 'content_table'

        /* Распределяем карты по секциям (разделам, подразделам, сериям) */
        for(var m in maps) {
            map = maps[m];
            /* Кладём карты, которые в раздел */
            if(map.subsection_id === null) {
                document.getElementById("sect" + map.section_id).getElementsByTagName("ul")[0].innerHTML +=
                    "<li class='map' id='map" +map.id+ "'>" +map.title+ "</li>";
            /* Кладём карты, которые в подраздел */
            } else if(map.series_id === null) {
                if(document.getElementById("subsect" + map.subsection_id) === null) {  // Если подраздела не существует
                    document.getElementById("sect" + map.section_id).getElementsByTagName("ul")[0].innerHTML +=  // Создаём подраздел в разделе
                        "<li class='subsect' id='subsect" +map.subsection_id+ "'>"  // Присваемаем li class подраздела и id
                        +subsections.filter(subsection => subsection.id == map.subsection_id)[0].title+  // Извлекаем из массива подразделов элемент, id которого совпадает с id подраздела из объекта карты
                        "<ul></ul></li>";
                }
                document.getElementById("subsect" + map.subsection_id).getElementsByTagName("ul")[0].innerHTML +=  // Кладём карту в подраздел
                    "<li class='map' id='map" +map.id+ "'>" +map.title+ "</li>";
            /* Кладём карты, которые в серию */
            } else { 
                if(document.getElementById("subsect" + map.subsection_id) === null) {  // Если подраздела не существует
                    document.getElementById("sect" + map.section_id).getElementsByTagName("ul")[0].innerHTML +=  // Создаём подраздел в разделе
                        "<li class='subsect' id='subsect" +map.subsection_id+ "'>"
                        +subsections.filter(subsection => subsection.id == map.subsection_id)[0].title+ 
                        "<ul></ul></li>";
                }
                if(document.getElementById("ser" + map.series_id) === null) {  // Если серии не существует
                    document.getElementById("subsect" + map.subsection_id).getElementsByTagName("ul")[0].innerHTML +=  // Создаём серию в подразделе
                        "<li class='ser' id='ser" +map.series_id+ "'>"
                        +series.filter(ser => ser.id == map.series_id)[0].title+
                        "<ul></ul></li>";
                }
                document.getElementById("ser" + map.series_id).getElementsByTagName("ul")[0].innerHTML +=  // Кладём карту в серию
                    "<li class='map' id='map" +map.id+ "'>" +map.title+ "</li>";
            } 
        }




        /* Интерактивность содержания: показать выходные данные */
        document.getElementById("sect_list").addEventListener("click", function(event) {
            var li_element = event.target;
            if(li_element){
                if(li_element.matches("li.sect.collapsibleListOpen")) {  // если действия происходят уже после щелчка, когда присвоен class="...Open"
                    var sect_id = li_element.id.substr(4);  // Извлекаем число (id в таблице) из html-id
                    var clicked_section = sections.filter(section => section.id == sect_id)[0];  // Берём раздел с совпадающим id из массива разделов
                    document.getElementById("obj_title").innerHTML = clicked_section.title;
                    document.getElementById("obj_description").innerHTML = clicked_section.description;
                } else if(li_element.matches("li.subsect.collapsibleListOpen")) {
                    var subsect_id = li_element.id.substr(7);
                    var clicked_subsection = subsections.filter(subsection => subsection.id == subsect_id)[0];
                    document.getElementById("obj_title").innerHTML = clicked_subsection.title;
                    document.getElementById("obj_description").innerHTML = clicked_subsection.description;
                } else if(li_element.matches("li.ser.collapsibleListOpen")) {
                    var ser_id = li_element.id.substr(3);
                    var clicked_series = series.filter(ser => ser.id == ser_id)[0];
                    document.getElementById("obj_title").innerHTML = clicked_series.title;
                    document.getElementById("obj_description").innerHTML = clicked_series.description;
                } else if(li_element.matches("li.map")) {
                    var map_id = li_element.id.substr(3);
                    var clicked_map = maps.filter(map => map.id == map_id)[0];
                    document.getElementById("obj_title").innerHTML = clicked_map.title;
                    document.getElementById("obj_description").innerHTML = clicked_map.description;
                    document.getElementById("map").getElementsByTagName("img")[0].setAttribute("src", "./img/" +map_id+ ".jpg");
                    document.getElementById("map").getElementsByTagName("img")[0].setAttribute("alt", "Карта временно недоступна");                 
                }
            }

        })
        

        /* Функция синхронного(!) ajax-запроса (метод устарел -> надо найти, чем заменить) */
        function loadData(phpFile, cFunction) {
            var xhr = new XMLHttpRequest();  // Создаём XMLHttpRequest-объект
            xhr.open("GET", phpFile, async = false);  // Открываем файл по адресу phpFile, выполняем GET-запрос; неасинхронный, чтобы положить данные в переменную
            xhr.onload = function() {
                if(this.status == 200) {  // Если запрос успешен (код 200),
                    cFunction(this);  // то выполняем функцию, которая принимает на вход xhr-объект
                }
            }
            xhr.send();
        }


        /* Фунцкции обработки полученных ajax-ом данных */
        function getMaps(xhr) {
            maps = JSON.parse(xhr.responseText);  // Парсим все карты, которые пришли
            document.getElementById("obj_title").innerHTML = maps[0].title;  // Сразу отображаем первую карту массива: название, описание, изображение
            document.getElementById("obj_description").innerHTML = maps[0].description;
            //document.getElementById("obj_description").innerHTML = "Lorem ipsum dolor sit amet consectetur adipisicing elit. Architecto sunt sapiente deserunt a itaque soluta, ullam molestias quibusdam? Impedit, pariatur quo architecto laborum amet repudiandae laudantium quos. Deleniti, facere ipsam accusamus saepe dolor soluta doloremque minima sit sequi obcaecati tempore, quo ipsum id est explicabo numquam, repellendus a. Rerum, cumque sunt nobis ex nihil nisi, sed illo qui debitis facere ipsa? Mollitia nostrum unde perferendis inventore libero soluta, ullam amet tempora sit. Quod numquam enim, quae reiciendis pariatur fuga soluta ducimus neque perferendis, rerum vero aperiam eligendi quia accusamus doloremque, culpa blanditiis corporis officiis sunt vel impedit quaerat incidunt id? Reprehenderit sapiente perspiciatis dolores, soluta architecto a voluptatum odit, itaque aliquam impedit quia nobis eveniet possimus? Voluptatibus dignissimos, possimus tempora voluptate maiores magnam nesciunt repellendus molestias rerum reprehenderit. Praesentium dignissimos non, voluptatibus hic ea tempore distinctio impedit vitae deleniti, quia cumque, quasi recusandae! Corrupti perspiciatis eveniet necessitatibus at deleniti atque ipsam. Quam illum dignissimos magni reprehenderit, rerum aspernatur tempore adipisci, incidunt harum optio dolorum ea vero sunt impedit neque repellat exercitationem doloremque consequuntur, dolor fugit tempora hic ipsum nisi saepe. A cum quaerat, accusantium natus suscipit officiis provident quam illum iste assumenda dolorum voluptatem est impedit, delectus beatae perferendis libero aut harum? Quos ipsam laudantium hic quae blanditiis accusantium similique porro natus iure dignissimos, repellat amet odit facilis quaerat ipsum explicabo nisi dolor neque harum voluptate dicta laborum maxime commodi. Aut accusantium quos error! Fuga, necessitatibus tempore! Labore, eaque beatae reprehenderit rem quod repellat consequuntur blanditiis corporis optio, veniam odio at tenetur explicabo impedit enim velit temporibus voluptates, obcaecati eveniet deleniti dolore sed magni vero? Ipsam explicabo quia accusantium aperiam omnis dolore quo excepturi fugiat minus, minima adipisci officia provident praesentium quis laborum ex, tempore, beatae reiciendis atque natus quas dolorem quibusdam. Nihil corporis quisquam nesciunt a laudantium recusandae ullam optio ut, sed harum quam ducimus? Accusamus sed eos alias reprehenderit qui facilis tempora fugiat architecto non veniam illo adipisci omnis maiores minus dolorum officia odio, culpa accusantium aperiam ex ipsum. Consequuntur id sit placeat ratione consequatur nemo, molestias inventore natus quaerat praesentium dolore qui dolorem corrupti nesciunt quo eos in quisquam delectus. Ratione adipisci, non eius hic excepturi iure voluptates maxime explicabo veritatis reprehenderit error ullam sequi porro animi. Doloremque natus adipisci fugit eius, placeat ad iure ut iusto magni aspernatur sequi animi pariatur quidem iste. Corrupti dolorem libero, ipsum ex est magni nisi iure fugit autem. Nobis excepturi laborum aliquam asperiores praesentium vero quibusdam ea eos dolore impedit? Pariatur eos suscipit itaque, aperiam blanditiis earum, at labore recusandae mollitia placeat nam illum minus harum. Dignissimos, autem libero. Facilis ullam, nam deleniti eligendi voluptate a! Ipsum sapiente distinctio voluptas unde delectus quidem, minus commodi maiores sit quas? Alias similique vitae, expedita aspernatur in veniam deleniti officia ea ipsum accusamus minus omnis ex, nisi doloribus quos! Numquam odit quos, iusto natus deserunt doloremque hic? Ullam obcaecati qui saepe nobis doloremque voluptas, laborum amet rerum deserunt cupiditate ipsam aperiam. Maiores esse temporibus exercitationem consectetur, aliquam reiciendis aspernatur inventore libero totam minus! Iste cumque sunt totam perspiciatis, laudantium libero natus a numquam rem eos officia cum sit provident culpa? Pariatur dignissimos aspernatur modi aut saepe eaque eligendi maxime ullam, sed quod obcaecati nam quia ipsa iure eveniet! Et esse sapiente illum assumenda dolor aliquid incidunt earum dolore odio corrupti, placeat eaque aut officiis modi iste, iusto voluptate maiores ducimus at rerum alias facilis non soluta! Deleniti voluptates ullam itaque fuga eligendi mollitia similique architecto dolores sed ipsum eum dolore quia pariatur, natus distinctio quaerat blanditiis, necessitatibus non cum exercitationem nisi, ipsam ducimus. Porro animi eligendi amet quis rerum nihil corporis, exercitationem quibusdam qui reiciendis atque, deserunt aspernatur voluptatum tempora distinctio magni natus nostrum! Temporibus reprehenderit cupiditate excepturi voluptatem quo, quos, possimus eligendi officia commodi sit omnis? Impedit totam aliquam maiores id quasi itaque facilis hic eligendi atque neque velit ducimus sapiente, voluptatibus omnis iusto natus pariatur, unde obcaecati quidem corrupti! Quasi voluptatum, suscipit voluptatem quas consectetur perspiciatis nesciunt natus, velit illo architecto recusandae culpa quis nostrum, fugiat odio minus rem. Eos sequi molestiae numquam dignissimos rem ea ad non eius. Maxime sed non accusamus, at mollitia laudantium voluptatum consequuntur vero aut deserunt, exercitationem sequi quae. A animi ullam provident quas eos id, repudiandae fuga temporibus minus mollitia corporis repellendus suscipit, accusamus error ad quaerat debitis hic consectetur reprehenderit possimus architecto. Harum cumque cum accusamus. Laudantium eaque ex modi aliquam atque, ab ipsa. Nesciunt libero dolorem rem vitae blanditiis? Aliquam quaerat earum, natus officia labore perferendis animi dolores facilis tenetur veritatis quisquam temporibus? Tempora neque atque doloribus obcaecati, laboriosam, deleniti ea aliquid molestias, voluptatum distinctio aut in eum officiis sint doloremque eos minus? Exercitationem vitae, distinctio vero facere, sed, temporibus voluptates officia dolores sunt ea aspernatur itaque veritatis tenetur quas porro excepturi asperiores aperiam provident optio! Voluptate nihil consectetur iusto quae minima praesentium, itaque, nulla, eveniet voluptatem et harum enim placeat sunt numquam? Consectetur mollitia minima quod laboriosam aspernatur? Minima quisquam sed sunt dolorum. Commodi accusantium harum quia nisi facere officiis laboriosam ea, fuga nulla magni culpa repellat incidunt ullam perferendis debitis distinctio dolorum quae error, amet repudiandae minima. Perspiciatis nesciunt facere vero repudiandae, quia facilis veniam omnis nobis eum, beatae natus quibusdam necessitatibus reprehenderit temporibus vel expedita blanditiis quo magni inventore delectus autem nostrum voluptatem. Non, officiis? Dignissimos iure reiciendis accusantium maxime alias molestiae quo explicabo distinctio eligendi odit adipisci, laboriosam magni rem sunt ratione totam minima doloribus necessitatibus maiores! Saepe nisi illo sapiente cumque quibusdam aspernatur! Ex minus rerum odit. Nam, pariatur quia? Quas odio fugit et sequi blanditiis recusandae placeat iure inventore error nisi explicabo voluptatum vitae ipsa voluptates assumenda sit non magnam, nulla esse. Illo id quasi reiciendis vitae ipsam? Molestiae dolores deserunt adipisci porro minima voluptate quasi neque odio explicabo quos assumenda optio consectetur fugit rem sint repudiandae, a velit officiis modi corrupti reprehenderit! Ut nesciunt alias suscipit, eos dolore facilis iusto possimus dignissimos voluptas velit, delectus, consectetur praesentium itaque amet optio iure corrupti quasi. Dolores vero explicabo animi fugit facilis earum doloremque consequuntur, numquam perspiciatis soluta in!";
            document.getElementById("map").getElementsByTagName("img")[0].setAttribute("src", "./img/0.jpg");
        }    

        function getSections(xhr) {
            sections = JSON.parse(xhr.responseText);
        }

        function getSubsections(xhr) {
            subsections = JSON.parse(xhr.responseText);
        }

        function getSeries(xhr) {
            series = JSON.parse(xhr.responseText);
        }
    </script>



    <!-- Interactive elements -->
    <script>
        /* Sidebar slider */
        function toggleContentTable() {
            var sidebar = document.getElementById("sidebar");
            var content_table = document.getElementById("content_table")
            var toggle = document.getElementById("toggle");
            if (sidebar.style.width != "350px") {  // Отталкиваемся от условия неравенства, так как проверяем параметр style, заданный в строке html, а его нет (он в css файле)
                sidebar.style.width = "350px";
                toggle.style.marginLeft = "360px";
                setTimeout(function(){content_table.style.display = "block";}, 350)  // Чтобы текст не перескакивал при развороте бокового меню, добавляем его через 0.3с после начала разворота
            } else {
                sidebar.style.width = "0px";
                toggle.style.marginLeft = "20px";
                content_table.style.display = "none";
            } 
        }
        
        /* Content table expand/collapse */
        CollapsibleLists.applyTo(document.getElementById('sect_list')); // Используем библиотеку
    </script>    
  </body>
</html>