<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="map viewer for the web-atlas of Crimea">
    <meta name="keywords" content="atlas, MSU, geography, cartography, Crimea">
    <meta name="author" content="Gman">
    <!-- CSS loading -->
    <link rel="stylesheet" type="text/css" hrefs="./css/style.css">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="icons/favicon.ico"/>
    <title>ВИЭ Крыма | Карты</title>
  </head>
  <body>
    <div class="container">
    

        <header class="row">
    
            <div id="brand">
                <h1>возобновляемые источники энергии<br>полуострова Крым</h1>
            </div>
    
            <nav>
                <ul>
                    <li class="hvr-fade"><a href="./index.html">ГЛАВНАЯ</a></li>
                    <li class="current hvr-fade"><a href="./maps.html">КАРТЫ</a></li>
                    <li class="hvr-fade"><a href="./contacts.html">КОНТАКТЫ</a></li>
                </ul>
            </nav>
    
        </header>
    
    
        <div class="row" id="showcase">
                <!-- <div id="toggle" onclick="toggleContentTable()">
                        <a href="#">
                            <svg width="30" height="30">
                                <path d="M0,5 30,5" stroke="dodgerblue" stroke-width="5" />
                                <path d="M0,14 30,14" stroke="dodgerblue" stroke-width="5" />
                                <path d="M0,23 30,23" stroke="dodgerblue" stroke-width="5" />
                            </svg>
                        </a>
                </div> -->
            <button type="button" class="tcon tcon-menu--xbutterfly" aria-label="toggle menu" id="toggle" onclick="toggleContentTable()">
                <span class="tcon-menu__lines" aria-hidden="true"></span>
                <span class="tcon-visuallyhidden">toggle menu</span>
            </button>
        
            <section id="sidebar">
                <div id="content_table">
                    <h2>Содержание</h2>
                    <div id="table_container"></div>
                </div>
            </section>
    
            <section id="map">
                <img src="">
            </section>
    
            <section id="info">
                <h2 id="obj_title"></h2>
                <p id="obj_description"></p>
            </section>
    
        </div>
    
    
        <footer class="row">
            <p>&copy; 2018-2019 Кафедра картографии и геоинформатики географического факультета МГУ</p>
        </footer>

    </div>








    <!-- JS loading -->
    <script src="./js/CollapsibleLists.js"></script>



    <script>
        /* Объявляем переменные хранения данных */
        var maps
        var sections
        var subsections
        var series

        /* Получаем данные */
        loadData("./php/getMaps.php", getMaps);
        loadData("./php/getSections.php", getSections);
        loadData("./php/getSubsections.php", getSubsections);
        loadData("./php/getSeries.php", getSeries);
        



        /* Создаём таблицу содержания */
        /* Создаём разделы */
        var sect_ul = "<ul id = 'sect_list'>";  // Открываем ul для списка карт
        for(var s in sections) {
            sect_ul += 
                "<li class='sect' id='sect" +sections[s].id+ "'>"  // Создаём li с названием каждого раздела; id равен индексу раздела в массиве 'sections' с префиксом 'sect'
                +sections[s].title+
                "<ul></ul></li>";
        }
        sect_ul += "</ul>";  // Закрываем ul для списка разделов
        document.getElementById('table_container').innerHTML += sect_ul; // Помещаем ul в раздел 'content_table'

        /* Распределяем карты по секциям (разделам, подразделам, сериям) */
        for(var m in maps) {
            map = maps[m];
            /* Кладём карты, которые в раздел */
            if(map.subsection_id === null) {
                document.getElementById("sect" + map.section_id).getElementsByTagName("ul")[0].innerHTML +=
                    "<li class='map' id='map" +map.id+ "'>" +map.title+ "</li>";
            /* Кладём карты, которые в подраздел */
            } else if(map.series_id === null) {
                if(document.getElementById("subsect" + map.subsection_id) === null) {  // Если подраздела не существует
                    document.getElementById("sect" + map.section_id).getElementsByTagName("ul")[0].innerHTML +=  // Создаём подраздел в разделе
                        "<li class='subsect' id='subsect" +map.subsection_id+ "'>"  // Присваемаем li class подраздела и id
                        +subsections.filter(subsection => subsection.id == map.subsection_id)[0].title+  // Извлекаем из массива подразделов элемент, id которого совпадает с id подраздела из объекта карты
                        "<ul></ul></li>";
                }
                document.getElementById("subsect" + map.subsection_id).getElementsByTagName("ul")[0].innerHTML +=  // Кладём карту в подраздел
                    "<li class='map' id='map" +map.id+ "'>" +map.title+ "</li>";
            /* Кладём карты, которые в серию */
            } else { 
                if(document.getElementById("subsect" + map.subsection_id) === null) {  // Если подраздела не существует
                    document.getElementById("sect" + map.section_id).getElementsByTagName("ul")[0].innerHTML +=  // Создаём подраздел в разделе
                        "<li class='subsect' id='subsect" +map.subsection_id+ "'>"
                        +subsections.filter(subsection => subsection.id == map.subsection_id)[0].title+ 
                        "<ul></ul></li>";
                }
                if(document.getElementById("ser" + map.series_id) === null) {  // Если серии не существует
                    document.getElementById("subsect" + map.subsection_id).getElementsByTagName("ul")[0].innerHTML +=  // Создаём серию в подразделе
                        "<li class='ser' id='ser" +map.series_id+ "'>"
                        +series.filter(ser => ser.id == map.series_id)[0].title+
                        "<ul></ul></li>";
                }
                document.getElementById("ser" + map.series_id).getElementsByTagName("ul")[0].innerHTML +=  // Кладём карту в серию
                    "<li class='map' id='map" +map.id+ "'>" +map.title+ "</li>";
            } 
        }




        /* Интерактивность содержания: показать выходные данные */
        document.getElementById("sect_list").addEventListener("click", function(event) {
            var li_element = event.target;
            if(li_element){
                if(li_element.matches("li.sect.collapsibleListOpen")) {  // если действия происходят уже после щелчка, когда присвоен class="...Open"
                    var sect_id = li_element.id.substr(4);  // Извлекаем число (id в таблице) из html-id
                    var clicked_section = sections.filter(section => section.id == sect_id)[0];  // Берём раздел с совпадающим id из массива разделов
                    document.getElementById("obj_title").innerHTML = clicked_section.title;
                    document.getElementById("obj_description").innerHTML = clicked_section.description;
                } else if(li_element.matches("li.subsect.collapsibleListOpen")) {
                    var subsect_id = li_element.id.substr(7);
                    var clicked_subsection = subsections.filter(subsection => subsection.id == subsect_id)[0];
                    document.getElementById("obj_title").innerHTML = clicked_subsection.title;
                    document.getElementById("obj_description").innerHTML = clicked_subsection.description;
                } else if(li_element.matches("li.ser.collapsibleListOpen")) {
                    var ser_id = li_element.id.substr(3);
                    var clicked_series = series.filter(ser => ser.id == ser_id)[0];
                    document.getElementById("obj_title").innerHTML = clicked_series.title;
                    document.getElementById("obj_description").innerHTML = clicked_series.description;
                } else if(li_element.matches("li.map")) {
                    var map_id = li_element.id.substr(3);
                    var clicked_map = maps.filter(map => map.id == map_id)[0];
                    document.getElementById("obj_title").innerHTML = clicked_map.title;
                    document.getElementById("obj_description").innerHTML = clicked_map.description;
                    document.getElementById("map").getElementsByTagName("img")[0].setAttribute("src", "./img/" +map_id+ ".png");
                    document.getElementById("map").getElementsByTagName("img")[0].setAttribute("alt", "Карта временно недоступна");                 
                }
            }

        })
        

        /* Функция синхронного(!) ajax-запроса (метод устарел -> надо найти, чем заменить) */
        function loadData(phpFile, cFunction) {
            var xhr = new XMLHttpRequest();  // Создаём XMLHttpRequest-объект
            xhr.open("GET", phpFile, async = false);  // Открываем файл по адресу phpFile, выполняем GET-запрос; неасинхронный, чтобы положить данные в переменную
            xhr.onload = function() {
                if(this.status == 200) {  // Если запрос успешен (код 200),
                    cFunction(this);  // то выполняем функцию, которая принимает на вход xhr-объект
                }
            }
            xhr.send();
        }


        /* Фунцкции обработки полученных ajax-ом данных */
        function getMaps(xhr) {
            maps = JSON.parse(xhr.responseText);  // Парсим все карты, которые пришли
            document.getElementById("obj_title").innerHTML = maps[0].title;  // Сразу отображаем первую карту массива: название, описание, изображение
            document.getElementById("obj_description").innerHTML = maps[0].description;
            document.getElementById("map").getElementsByTagName("img")[0].setAttribute("src", "./img/1.png");
        }    

        function getSections(xhr) {
            sections = JSON.parse(xhr.responseText);
        }

        function getSubsections(xhr) {
            subsections = JSON.parse(xhr.responseText);
        }

        function getSeries(xhr) {
            series = JSON.parse(xhr.responseText);
        }
    </script>



    <!-- Interactive elements -->
    <script>
        /* Sidebar slider */
        function toggleContentTable() {
            var sidebar = document.getElementById("sidebar");
            var content_table = document.getElementById("content_table")
            var toggle = document.getElementById("toggle");
            if (sidebar.style.width != "350px") {  // Отталкиваемся от условия неравенства, так как проверяем параметр style, заданный в строке html, а его нет (он в css файле)
                sidebar.style.width = "350px";
                toggle.style.marginLeft = "360px";
                setTimeout(function(){content_table.style.display = "block";}, 350)  // Чтобы текст не перескакивал при развороте бокового меню, добавляем его через 0.3с после начала разворота
            } else {
                sidebar.style.width = "0px";
                toggle.style.marginLeft = "20px";
                content_table.style.display = "none";
            } 
        }

        /* Slider button animation (minified from http://www.transformicons.com) */
        !function(r,n){"function"==typeof define&&define.amd?define(n):"object"==typeof exports?module.exports=n():r.transformicons=n()}(this||window,function(){"use strict";var r={},n={transform:["click"],revert:["click"]},t=function(r){return"string"==typeof r?Array.prototype.slice.call(document.querySelectorAll(r)):void 0===r||r instanceof Array?r:[r]},o=function(r){return"string"==typeof r?r.toLowerCase().split(" "):r},e=function(r,e,f){var i=(f?"remove":"add")+"EventListener",s=t(r),a=s.length,u={};for(var l in n)u[l]=e&&e[l]?o(e[l]):n[l];for(;a--;)for(var d in u)for(var m=u[d].length;m--;)s[a][i](u[d][m],c)},c=function(n){r.toggle(n.currentTarget)};return r.add=function(n,t){return e(n,t),r},r.remove=function(n,t){return e(n,t,!0),r},r.transform=function(n){return t(n).forEach(function(r){r.classList.add("tcon-transform")}),r},r.revert=function(n){return t(n).forEach(function(r){r.classList.remove("tcon-transform")}),r},r.toggle=function(n){return t(n).forEach(function(n){r[n.classList.contains("tcon-transform")?"revert":"transform"](n)}),r},r});
        transformicons.add('.tcon');

        /* Content table expand/collapse */
        CollapsibleLists.applyTo(document.getElementById('sect_list')); // Используем библиотеку

    </script>    
  </body>
</html>